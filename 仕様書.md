# NeiBot 現行仕様書

## 1. プロジェクト概要
- Twitch サブスクライバーを Discord サーバーへ自動連携するボット／管理パネルの統合プロジェクト。
- メイン機能は Discord ボット (`bot/bot_client.py`) が担い、FastAPI で OAuth コールバックと EventSub Webhook を受け、Twitch 側のサブスク状態を `db.sqlite3` に反映する（旧 `venv/all_users.json` は初回起動時に DB へ自動移行）。
- Django 管理サイト (`webadmin/`) を併設し、ダッシュボード・DM 一斉送信・EventSub 管理などの運用 UI を提供。
- 本番環境は Windows Server 上で `uvicorn`(127.0.0.1:8000)・Django(127.0.0.1:8001) を常駐、Nginx＋Let’s Encrypt 証明書で HTTPS 公開する。

## 2. システム構成
- **Discord Bot (py-cord)**: スラッシュコマンド(`/link`, `/unlink`, `/force_relink` など)と自動 DM を提供。APScheduler で毎月の再リンクリマインド、ロール再付与／剥奪を実行。
- **FastAPI アプリ (`bot/bot_client.py`)**: OAuth コールバック `/twitch_callback`、EventSub Webhook `/twitch_eventsub`、管理 API (`/guilds`, `/roles`, `/send_role_dm` など) を実装。ボットと同一プロセス内で Uvicorn によりスレッド起動。
- **管理コンソール (Django)**: `webadmin/panel` アプリが `db.sqlite3` をリードオンリーで参照し、ダッシュボード・未解決ユーザー一覧・Twitch CSV 取り込み・EventSub 管理 UI を構成。`RUN_DJANGO=1` 環境変数でボット起動時に自動起動可能。
- **データストア**:
  - `venv/all_users.json`: 旧形式のバックアップ。DB にデータが無い場合のみ初回に読み込まれ、以降は更新されない。
  - `db.sqlite3`: `linked_users`・`webhook_events`・`cheer_events` を持つ。ボットと Django で共有。
  - 補助 JSON (`venv/token.json`, `role_id.json`, `channel_id.json`, `category_id.json`, `subscription_config.json`) でトークン／ロール紐付け／通知先チャンネル等を保持。
- **外部サービス**: Twitch OAuth, EventSub, Bits API、Discord HTTP API。HTTPS 終端は Nginx (Let’s Encrypt 証明書)。

## 3. 機能詳細
### 3.1 Discord ボット
- コア: `bot/bot_client.py`
  - `on_ready` でギルド情報をキャッシュし、サブスクロール／カテゴリー／チャンネルを自動生成 (`make_subrole`, `make_category_and_channel`)。
  - `register_eventsub_subscriptions()` を起動時に呼び、必要な EventSub サブスクリプションを自動登録。
- Slash Commands (`bot/cogs/`):
  - `link.py`: `/link` 実行で Twitch OAuth URL を DM。`linked_users` テーブルを監視し、連携完了後にロール付与・ステータス DM 送信。
  - `unlink.py`: `/unlink` でストアから該当ユーザーを削除。
  - `monthly_relink_bot.py`: `/force_relink`, `/force_resend`, `/relink_status` を提供し、月次 DM スケジュールを制御。未解決ユーザーには 7 日後に再送・ロール剥奪。
  - `auto_link_dm.py`: 新規参加者に `/link` 案内 DM。
- EventSub 対応:
  - `apply_event_to_linked_users()` が `channel.subscribe`, `channel.subscription.message`, `channel.subscription.end`, `channel.cheer` を解析し、`linked_users` を更新。`channel.cheer` イベントは `cheer_events` テーブルへも記録。
  - `stream.online` 受信時は `notify_stream_online()` が通知チャンネルへ配信開始メッセージを投稿。
- データ整合: `reconcile_and_save_link()` が streak/cumulative/subscribed_since を再計算し、`resolved` フラグ・ロール剥奪状態を更新。
- スケジューラ: APScheduler (`Asia/Tokyo`)
  - 毎月 1 日 09:05 `/link` 再案内 DM (`notify_monthly_relink`)
  - 毎日 09:10 未解決ユーザーへ再送 (`resend_after_7days_if_unlinked`)、必要に応じてロール剥奪。

### 3.2 FastAPI エンドポイント
| メソッド | パス | 概要 | 認証 |
| --- | --- | --- | --- |
| POST | `/notify_link` | 管理 UI から個別 DM を要求 | Bearer Token |
| GET | `/guilds` | 参加ギルド一覧 | Bearer Token |
| GET | `/roles` | 指定ギルドのロール一覧 | Bearer Token |
| POST | `/send_role_dm` | 指定ロール全員へ DM 送信。添付(最大 10 個)と `{user}` 置換対応 | Bearer Token |
| GET | `/eventsub/subscriptions` | EventSub 登録一覧 | Bearer Token |
| POST | `/eventsub/subscriptions` | EventSub 登録作成 (type/version/condition 指定) | Bearer Token |
| DELETE | `/eventsub/subscriptions/{id}` | 登録削除 | Bearer Token |
| GET | `/twitch_callback` | Twitch OAuth コールバック。アクセストークン取得→`reconcile_and_save_link` で保存 | なし |
| GET/HEAD/POST | `/twitch_eventsub` | EventSub 検証／通知受信。HMAC 検証後に `inbox_enqueue_event` & `apply_event_to_linked_users` | なし |

Bearer 認証には `venv/token.json` の `admin_api_token` を利用。`Authorization: Bearer <token>`。

### 3.3 Django 管理画面 (`webadmin/panel`)
- 認証は `django-allauth`。`settings.ADMIN_API_TOKEN` / `BOT_ADMIN_API_BASE` を使って FastAPI へ REST リクエスト。
- 主要ビュー (`webadmin/panel/views.py`):
  - `index`: 連携済み／未解決数、Tier 内訳、DM 失敗などをダッシュボード表示。`linked_users` を集計。
  - `unresolved_users`: 再リンク未完了ユーザーリスト。CSV ダウンロードも提供。
  - `self_service`: 自己解決用エントリ管理 (OAuth 再リンク URL、最終更新日時等)。
  - `import_subscribers`: Twitch CSV (`subscriber-list.csv`) をアップロードし `linked_users` を一括更新。既存レコードとマージし `resolved` 状態を制御。
  - `broadcast`: `RoleBroadcastForm` でロール選択・DM 文面・添付 (最大 8MB × 複数) を指定して一斉送信。
  - `eventsub_admin`: EventSub サブスクリプションの照会・追加・削除 UI。
- `panel/forms.py` で複数ファイル添付や `{user}` プレースホルダ検証を実装。
- `panel/models.py` は SQLite のテーブルを `managed=False` でマッピング。

### 3.4 補助ツール
- `scripts/eventsub_local_test.py`: ローカルで OAuth なしに EventSub Webhook を擬似送信できる CLI。`--start-server` で Uvicorn を同時起動し、`channel.subscribe` → `message` → `end` を送信。
- `notebooks/NeiBot_EventSub_LocalTests.ipynb`: Jupyter で Webhook 検証を行い、`db.sqlite3` の反映を確認する。
- `bot/scripts/migrate_role_ids.py`: ロール ID の移行補助スクリプト。

## 4. データストア仕様
### 4.1 JSON ファイル (`venv/` 配下)
- `token.json`
  ```json
  {
    "discord_token": "...",
    "guild_id": 123456789012345678,
    "twitch_client_id": "...",
    "twitch_secret_key": "...",
    "twitch_redirect_uri": "https://<domain>/twitch_callback",
    "twitch_access_token": "...",      // Broadcaster token
    "twitch_id": "12345678",           // Broadcaster user_id
    "admin_api_token": "..."           // 任意: 管理 API/Bot パネル連携用
  }
  ```
- `all_users.json`（legacy）: Discord ID ごとの辞書。現在は初回移行時の読み込みのみで、以降は `linked_users` テーブルが唯一のソースとなる。
- `role_id.json`/`channel_id.json`/`category_id.json`: ギルド ID → ロール／チャンネル ID のマップ。
- `subscription_config.json`: サブスク Tier のカスタム設定。空の場合 `DEFAULT_SUBSCRIPTION_CONFIG` を自動書き込み。`tiers[n]` に `role_name`, `category_name`, `channel_name`, `view_roles` を指定可能。`linked_role_name`, `notify_role_name`, `notify_channel_id` も上書き可。

### 4.2 SQLite (`db.sqlite3`)
- `linked_users(discord_id PRIMARY KEY, data TEXT, created_at TEXT, updated_at TEXT)`
- `webhook_events(source, delivery_id PRIMARY KEY, event_type, twitch_user_id, payload TEXT, headers TEXT, status TEXT, retries INT, error TEXT, received_at TEXT, processed_at TEXT)`
- `cheer_events(id AUTOINCREMENT, twitch_user_id, bits INT, is_anonymous INT, message TEXT, payload TEXT, cheer_at TEXT)`

## 5. 外部連携とフロー
### 5.1 `/link`〜OAuth 流れ
1. ユーザーが `/link`。ボットが OAuth URL (`state=discord_id`) を DM。
2. Twitch が `https://<domain>/twitch_callback` に `code` と `state` でリダイレクト。
3. FastAPI がアクセストークンを取得し、`get_user_info_and_subscription()` でサブスク情報・Bits を Helix API から取得。
4. `reconcile_and_save_link()` が streak/cumulative/subscribed_since/DM 失敗情報を更新し、`resolved=True` とロール付与フラグをセット。
5. Cog 側が検知し、ギルドに `Twitch-linked` + Tier ロールを付与 (旧 Tier ロールは除去)。

### 5.2 EventSub
- 初期登録時に `register_eventsub_subscriptions()` が App Access Token で以下を登録: `channel.subscribe`, `channel.subscription.message`, `channel.subscription.end`, `channel.cheer`, `stream.online` (必要に応じ追加)。
- Twitch→`/twitch_eventsub` (POST)。ヘッダー `Twitch-Eventsub-Message-Signature` を `twitch_secret_key` で HMAC 検証。
- 通知は `webhook_events` に格納後 `apply_event_to_linked_users()` でリンク済み Discord ID を検索し更新。
- `stream.online` の場合 `STREAM_NOTIFY_ROLE_NAME` が設定されていれば通知チャンネルへ投稿。

### 5.3 月次リマインド
- `linked_users` から `resolved=False` かつ `last_notice_at` なしのユーザーに `/link` 案内 DM。
- 7 日経過しても未解決の場合ロール剥奪 (`roles_revoked=True`) と DM 再送。

## 6. 環境設定・起動
- Python 3.12 / `py-cord 2.6.1`。`requirements.txt` 参照。
- 初回セットアップ
  ```powershell
  python -m venv venv
  venv\Scripts\activate
  pip install -r requirements.txt
  ```
- 起動コマンド: `python bot/bot_client.py`
  - 環境変数
    - `DEBUG=1` で詳細ログ。
    - `APP_ENV=prod` で FastAPI の `/docs` 等を無効化。
    - `TWITCH_EVENTSUB_CALLBACK`, `TWITCH_EVENTSUB_SECRET` で `token.json` を上書き可能。
    - `RUN_DJANGO=1` で `python webadmin/manage.py runserver 127.0.0.1:8001` を子プロセス起動。
    - `BOT_ADMIN_API_BASE` (管理 UI から使用。既定は `http://127.0.0.1:8000`)。
    - `ADMIN_API_TOKEN` (Django 側設定。`token.json` の値と一致させる)。

## 7. 本番運用構成
- **プロセス**: Windows サービスまたはタスクスケジューラで `venv\Scripts\activate` → `python bot/bot_client.py` を常駐。
- **Nginx (`nginx.conf`)**
  - ポート 80→443 へリダイレクト。
  - Let’s Encrypt で取得した PEM (`C:/certs/...`) を設定。`ssl_trusted_certificate` も同チェーンを指定。
  - `limit_req_zone` によるレート制限、ホスト／User-Agent／パスフィルタで不正アクセス遮断。
  - `/twitch_callback`, `/twitch_eventsub` は 127.0.0.1:8000 (FastAPI) へリバースプロキシ。HTTP メソッドを制限し、EventSub のバッファリングを無効化。
  - `/` `/panel/` `/accounts/` 等は 127.0.0.1:8001 (Django) へプロキシ。
  - `/static/` `/media/` はローカルディレクトリから直接配信。
- **証明書更新**: Let’s Encrypt (win-acme 等) で自動更新。`isrgrootx1.pem`, `neige-fullchain.pem` 等はリポジトリに同梱済みだが、本番では定期更新された証明書パスを Nginx へ指定。

## 8. 運用・監視
- ログ: 既定は標準出力。`DEBUG=1` で詳細ログが FastAPI/ボットともに表示。
- `webhook_events` テーブルで過去 EventSub/DM 送信結果を保全。`status` が `failed` のものは Django UI で確認。
- DM 送信失敗 (`dm_failed` フラグ) は Dashboard の「DM 失敗サンプル」に表示。
- 管理 API は Bearer トークンで保護されるため、Django `settings.py` の `ADMIN_API_TOKEN` も更新時は `token.json` と同期すること。

## 9. テスト・検証手順
- **ローカル Webhook テスト**: `python scripts/eventsub_local_test.py --start-server` を実行し、Twitch CLI なしでサブスク通知の CRUD を確認。
- **ノートブック検証**: `notebooks/NeiBot_EventSub_LocalTests.ipynb` で署名付き Webhook を順に投げ、`db.sqlite3` に反映されるレコードを確認。
- **管理 UI テスト**: `RUN_DJANGO=1 DEBUG=1` で起動し、`http://127.0.0.1:8001/panel/` にアクセス。`ADMIN_API_TOKEN` が正しいことを確認。

## 10. 既知の前提・注意点
- Discord ボットは `Intents.all()` を要求。サーバー側で Bot の特権インテント (SERVER MEMBERS, MESSAGE CONTENT 不要) を有効化しておく。
- `venv/all_users.json` はレガシー互換用バックアップのみ。直接編集しても `linked_users` には反映されず、将来的に削除予定。
- Twitch API のスコープ:
  - Viewer OAuth: `user:read:subscriptions` (必須)。
  - Broadcaster token: `channel:read:subscriptions`、Bits 集計を利用する場合 `bits:read`。
- EventSub Webhook は必ず HTTPS/443（Let’s Encrypt 証明書）で公開し、Twitch ダッシュボードの Redirect URL を最新に保つ。
- DM 添付は Discord 制限により 8MB 以下／1 リクエスト 10 ファイルまで。大容量配布は `file_url` で外部 CDN を指定する。
- Nginx で `/admin/` パスを 444 応答にしているため、Django 管理サイトは公開 URL から直接アクセス不可。`/accounts/login/` 経由でログインする。

---
この仕様書は 2025-10-04 時点のリポジトリ構成を基点とし、主要動作・設定・外部連携を整理したものである。
